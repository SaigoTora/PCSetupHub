@using System.Globalization
@using HtmlAgilityPack

@using PCSetupHub.Core.External.NewsApi


@model Article[]

@{
    ViewData["Title"] = "Home";

    <link rel="stylesheet" href="~/css/news.css" />

    string ExtractPlainText(string? rawContent)
    {
        if (string.IsNullOrEmpty(rawContent))
            return string.Empty;

        // Remove cropping view [+1234 chars]
        int cutIndex = rawContent.IndexOf("[+");
        if (cutIndex > 0)
            rawContent = rawContent.Substring(0, cutIndex);

        // Remove all html tags
        var doc = new HtmlDocument();
        doc.LoadHtml(rawContent);
        return doc.DocumentNode.InnerText.Trim();
    }
}


@if (Model != null)
{
    <h1 class="mb-5 fw-bold"><span class="text-accent">Tech</span> News</h1>
    for (int i = 0; i < Model.Length; i++)
    {
        Article article = Model[i];
        string publishedDate = article.PublishedAt.ToLocalTime().ToString("d MMMM, yyyy 'at' HH:mm", new CultureInfo("en-US"));

        <div class="news-container @(i == 0 ? "mt-0" : "")">
            <h3 class="news-title mb-3 text-center"><span class="user-select-none">@(i + 1). </span>@article.Title</h3>
            @if (!string.IsNullOrEmpty(article.UrlToImage))
            {
                <div class="news-image-container mb-2-5">
                    <img src="@article.UrlToImage" class="news-image" alt="News image" title="@article.Title" loading="lazy" />
                </div>
            }
            <div class="news-content ps-3 mb-2">
                @ExtractPlainText(article.Content)
                @if (!string.IsNullOrEmpty(article.Url))
                {
                    <a class="news-link ms-1" href="@article.Url" target="_blank" rel="noopener noreferrer">Read more</a>
                }
            </div>

            <div class="d-flex justify-content-between ps-4">
                <div>
                    <i class="news-source-name">@article.Source.Name</i>
                    @if (!string.IsNullOrEmpty(article.Author))
                    {
                        <span>
                            -
                            <i class="news-author">@article.Author</i>
                        </span>
                    }
                </div>
                <div class="news-publish-date" title="@publishedDate">@publishedDate</div>
            </div>
        </div>

        if (i != Model.Length - 1)
        {
            <hr />
        }
    }
}
else
{
    <h1 class="display-4 mb-5">Welcome</h1>
    <p class="text-center fs-5">
        <b class="pe-1"><span class="text-accent">PC</span> Setup Hub</b> is a community about computers and hardware where you can share builds, exchange ideas, and connect with others.
    </p>
}